version: 2.1
orbs:
  ruby: circleci/ruby@1.1.4
  node: circleci/node@4.7.0
  aws-ecr: circleci/aws-ecr@7.2.0
  slack: circleci/slack@4.4.4

jobs:
  build-deps:
    docker:
      - image: cimg/ruby:3.0.0-node
    steps:
      - checkout

      - run:
          name: Which bundler?
          command: bundle -v
      - run:
          command: bundle config set without test
      - ruby/install-deps

      - run:
          name: Which yarn?
          command: yarn -v
      - node/install-packages:
          pkg-manager: yarn

      - persist_to_workspace:
          root: .
          paths:
            - .

  build-image:
    docker:
      - image: cimg/base:2021.04
    steps:
      - attach_workspace:
          at: .
      - aws-ecr/build-and-push-image:
          checkout: false
          repo: $ENVIRONMENT-$SITE-snt-apps
          #remote-docker-layer-caching: true
          setup-remote-docker: yes
          tag: ${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}${CIRCLE_TAG}

  test:
    docker:
      - image: cimg/ruby:3.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          command: bundle config set with test
      - ruby/install-deps
      - run:
          command: |
            echo -e "test:\n  mode: backend" > config/mode.yml &&
            bundle exec rake test
      - store_test_results:
          path: test/reports
      - store_artifacts:
          path: coverage

  notify:
    docker:
      - image: cimg/base:2021.04
    steps:
      - slack/notify:
          channel: cicd

workflows:
  develop:
    jobs:
      - build-deps
      - test:
          requires:
            - build-deps
      - build-image:
          requires:
            - build-deps
